---
title: "Consolidated data wrangling & analysis"
author: "Carmel, Mathews, Andrea, Nicole"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

# Fish Diversity Correlation to Macroinvertebrate Diversity Over Time

Authors: Andrea Mascioli, Carmel Serban, Nicole Landry, Matthews Do Carmo Nascimiento

## Load necessary packages

```{r chunk 1, message = FALSE}
library(tidyverse)
library(here)
library(neonUtilities)
```

## Load raw datasets

```{r chunk 2}
# Fish sampled
fish_raw <- read_csv(here("data", "raw", "fsh_perFish.csv"))

# Macroinvertebrates
macro_raw <- read_csv(here("data", "raw", "inv_taxonomyProcessed.csv")) 

# Stream temperature
temp_raw <- read_csv(here("data", "raw", "TSW_30min.csv"))

```

# Data wrangling (Selecting fish diversity and macroinvertebrate data)

## Fish diversity
```{r chunk 3}

## Select focal variables for fish
fish_select <- fish_raw %>% 
  mutate(taxonID = factor(taxonID),
         siteID = factor(siteID),
         sample_month = as_date(floor_date(passStartTime, "month")),
         month = month(sample_month),
         year = year(sample_month),
         season = factor(ifelse(month %in% c(3,4,5), "spring",
                         ifelse(month %in% c(6,7,8), "summer",
                                ifelse(month %in% c(9,10,11), "fall", "winter"))))) %>% 
  #filter(season %in% c("spring", "fall")) %>% 
  select(siteID, sample_month, month, year, season, taxonID, scientificName, fishWeight)

```

Summarize fish diversity by month/year and season
```{r}
fish_by_month <- fish_select %>% 
  group_by(siteID, sample_month) %>% 
  summarize(fish_unique_taxa = n_distinct(taxonID),
            total_individuals = n(),
            total_biomass = sum(fishWeight, na.rm = TRUE)) %>% 
  write_csv(., here("data", "processed", "fish_by_month.csv"))

print(fish_by_month) 

## Summarize fish diversity by season 
fish_by_season <- fish_select %>%
  group_by(siteID, season, year) %>%
  summarize(fish_unique_taxa = n_distinct(taxonID),
            total_individuals = n(),
            total_biomass = sum(fishWeight, na.rm = TRUE)) %>% 
  write_csv(., here("data", "processed", "fish_by_season.csv"))

print(fish_by_season)

```

## Macroinvertebrates
```{r}

## Select focal variables
macro_select <- macro_raw %>% 
  mutate(taxonID = factor(acceptedTaxonID),
         siteID = factor(siteID),
         sample_month = as_date(floor_date(collectDate, "month")),
        month = month(sample_month),
         year = year(sample_month),
         season = factor(ifelse(month %in% c(3,4,5), "spring",
                         ifelse(month %in% c(6,7,8), "summer",
                                ifelse(month %in% c(9,10,11), "fall", "winter"))))) %>% 
  filter(season %in% c("spring", "fall")) %>% 
  select(siteID, sample_month, month, year, season, genus, taxonID, scientificName, sizeClass, sizeCategory, individualCount, estimatedTotalCount)

## Separate data to get macroinvertebrate data by month.
macro_by_month <- macro_select %>% 
  group_by(siteID, sample_month) %>% 
  summarize(macro_unique_taxa = n_distinct(taxonID),
            total_individuals = sum(estimatedTotalCount)) %>% 
  write_csv(., here("data", "processed", "macro_by_month.csv"))

print(macro_by_month)

macro_by_season <- macro_select %>%
  group_by(siteID, season, year) %>%
  summarize(macro_unique_taxa = n_distinct(taxonID),
            total_individuals = sum(estimatedTotalCount)) %>% 
  write_csv(., here("data", "processed", "macro_by_season.csv"))

print(macro_by_season)

```

## Join fish and macro 
Join by siteID, season, and year to retain unique taxa for fish and macroinverts

```{r}
joined_data <- full_join((fish_by_season %>% 
                            select(siteID:fish_unique_taxa)),
                          (macro_by_season %>% 
                            select(siteID:macro_unique_taxa)))

head(joined_data)
```
Linear regression for macro diversity vs. fish diversity
```{r}
# Specify our linear model
lmodel1 <- lm(macro_unique_taxa ~ fish_unique_taxa, data = joined_data)

# Print regression output
summary(lmodel1)

```

Make a graph of fish as a function of inverts
```{r}
ggplot(joined_data,
       aes(x = macro_unique_taxa,
           y = fish_unique_taxa)) +
  geom_point(cex = 2, aes(col = siteID)) +
  theme_bw()

```
DONT USE THIS ITS PEAHACKING
```{r}
graph_data <- joined_data %>% 
  filter(fish_unique_taxa >= 11) %>% 
  filter(fish_unique_taxa <= 30)

ggplot(graph_data,
       aes(x = macro_unique_taxa,
           y = fish_unique_taxa)) +
  geom_point(cex = 2, aes(col = siteID)) +
  theme_bw()

# Specify our linear model
lmodel2 <- lm(macro_unique_taxa ~ fish_unique_taxa, data = graph_data)

# Print regression output
summary(lmodel2)
```

# Data analysis

## Macroinvertebrate ANOVA

**KF note: Here and for fish below, remember that ANOVA is testing for differences in mean values across groups, not correlation among variables!**

Use an ANOVA test to find correlation between unique species and season for each site
```{r chunk 5}

# Set up model
unique_taxa_aov_macro <- aov(macro_unique_taxa ~ season * siteID, data = macro_by_season)

summary(unique_taxa_aov_macro)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov_macro, which = 1:3)

# Additive Model
unique_taxa_aov2_macro <- aov(macro_unique_taxa ~ season + siteID, data = macro_by_season)

summary(unique_taxa_aov2_macro)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov2_macro, which = 1:3)

```
The data above from the ANOVA test and Additive models show that the siteID's have a significant correlation among them, while season and season:siteID do not have significant correlation. Essentially, the trend we are seeing with seasons and the fluxuations of species diversity are consistant between sites. The p value for siteID was 7.39x10^-7, and the F value was 71.097.Relationship is non linear as displayed by the residuals vs fitted plot, Residuals are approximately normally distributed as seen in the q-q residuals plot, and the there is not a constant variation of residuals as displayed in the scale-location plot.

## Fish ANOVA
```{r chunk 5}

unique_taxa_aov_fish <- aov(fish_unique_taxa ~ season * siteID, data = fish_by_season)

summary(unique_taxa_aov_fish)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov_fish, which = 1:3)

# Additive Model
unique_taxa_aov2_fish <- aov(fish_unique_taxa ~ season + siteID, data = fish_by_season)

summary(unique_taxa_aov2_fish)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov2_fish, which = 1:3)
```
The ANOVA test and Additive model reflect the same results as the macroinvertebrate data, with siteID proving significant correlation within them. The p value is 4.37x10^-5 and the F value is 63.984. This data informs us that the fluxuations of species diversity are not only consistant between sites, but also across fish species and macroinvertebrate species, regardless of the site location and geography.Relationship is non linear as displayed by the residuals vs fitted plot, Residuals are not approximately normally distributed as seen in the q-q residuals plot, and the there is not a constant variation of residuals as displayed in the scale-location plot.


```{r chunk 6}
# MACRO SITE GRAPH

ggplot(macro_by_season,
       aes(x = season,
           y = macro_unique_taxa,
           fill = siteID)) +
  geom_boxplot() +
  theme_bw()

```
The box plot above shows the data for the unique macroinvertebrate species collected between both sites MAYF and BIGC. The y axis shows the number of unique taxa collected while the x axis shows the season. The blue bars show MAYF data while the orange/red bars show data for BIGC. The overall trend for both sites looks relatively similar, however the MAYF site does show a considerable less amount of unique macroinvertebrates collected.

```{r chunk 6}
# FISH SITE GRAPH

ggplot(fish_by_season,
       aes(x = season,
           y = fish_unique_taxa,
           fill = siteID)) +
  geom_boxplot() +
  facet_wrap(. ~ siteID, 
             scales = "free_y") +
  theme_bw()

```

The box plot above shows the data for the unique fish species collected between both sites MAYF and BIGC. The y axis shows the number of unique taxa collected while the x axis shows the season. The blue bars show MAYF data while the orange/red bars show data for BIGC. The graphs havee been split to show the very low amount of BIGC fish collected when compared to MAYF. The BIGC fish species start low in the fall and spike in the spring, with no data to show for winter. The MAYF fish species show an opposite trend, with unique taxa collected being high in the fall and decrease in the spring and are lowest in the winter.

```{r}
# KF added: Unique taxa over time at each site (just for fun/if useful)
ggplot(joined_data,
       aes(x = year,
           y = fish_unique_taxa,
           col = siteID)) +
  geom_line() +
  facet_wrap(. ~ siteID, 
             scales = "free_y") +
  theme_bw()
```


```{r chunk 7}
#Second graph with additional context
ggplot() +
  geom_point(data = fish_by_month, aes(x=sample_month, y=fish_unique_taxa, colour = "Fish"))+
  geom_point(data = macro_by_month, aes(x=sample_month, y=macro_unique_taxa, colour = "Macroinvertebrates"))+
  theme_bw()+
  labs(x = "Month",
       y = "Number of different species")+
  scale_colour_manual(values = c("red","blue"))+
  ggtitle("Plot of diversity per month")

```

In the graph above, we used a scatterplot with the y axis representing the number of different unique species, and the x axis showing months. This graph shows the species counts of fish (represented by red dots) and species count of macroinvertebrates (represented by blue dots). The above trend is a bit murky to interpret, but for macroinvertebrate data, there are peaks at the beginning and end of the year, while the fish species count stays relatively consistant.

