---
title: "Consolidated data wrangling & analysis"
author: "Carmel, Mathews, Andrea, Nicole"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

# Fish Diversity Correlation to Macroinvertebrate Diversity Over Time

Authors: Andrea Mascioli, Carmel Serban, Nicole Landry, Matthews Do Carmo Nascimiento

## Load necessary packages

```{r chunk 1, message = FALSE}
library(tidyverse)
library(here)
library(neonUtilities)
```

## Load raw datasets

```{r chunk 2}
# Fish sampled
fish <- read_csv(here("data", "raw", "fsh_perFish.csv"))

str(fish)

# Macroinvertebrates
macro_raw <- read_csv(here("data", "raw", "inv_taxonomyProcessed.csv")) 
str(macro_raw)

# Temperature
list2env((loadByProduct(dpID = site_temperatures, 
                        site = my_sites, 
                        include.provisional = TRUE,
                        startdate = start_date,
                        enddate = end_date)),
         .GlobalEnv)

variables_20120 %>% 
  write_csv(here("data", "raw", "variables_20120.csv"))

inv_taxonomyProcessed %>% 
  write_csv(here("data", "raw", "inv_taxonomyProcessed.csv"))
```

## Data wrangling (Selecting fish diversity and macroinvertebrate data)

```{r chunk 3}
## Select focal data for fish.
fish_select <- fish %>% 
  select(taxonID, siteID, passStartTime)

## Separate fish diversity by month from other data.

fish_by_month <- fish_select %>% 
  mutate(month = month(passStartTime),
         year = year(passStartTime)) %>% 
  group_by(siteID, year, month) %>% 
  summarize(unique_taxa = n_distinct(taxonID)) %>% 
  ## write fish_by_month as a separate .csv
  write_csv(fish_by_month, here("data", "processed", "fish_by_month.csv"))

print(fish_by_month) 

# Macroinvertebrate data wrangling:

## Read macroinvertebrate data.


names(macro_raw)

## Select raw data.

macro_select <- macro_raw %>% 
  select(acceptedTaxonID, collectDate, siteID)

## Separate data to get macroinvertebrate data by month.

 macro_by_month <- macro_select %>% 
  mutate(month = month(collectDate),
         year = year(collectDate)) %>%
  group_by(siteID, year, month) %>% 
  summarize(unique_taxa = n_distinct(acceptedTaxonID))

print(macro_by_month)

```

## Sorting by season
```{r chunk 4}
# MACROINVERTS

macro_by_season <- macro_select %>%
  mutate(month = month(collectDate),
         year = year(collectDate),
         siteID = factor(siteID),
         season = factor(ifelse(month %in% c(3,4,5), "spring",
                         ifelse(month %in% c(6,7,8), "summer",
                                ifelse(month %in% c(9,10,11), "fall", "winter"))))) %>%
  group_by(siteID, season, year, month) %>%
  summarize(unique_taxa = n_distinct(acceptedTaxonID))
print(macro_by_season)

# FISH

fish_by_season <- fish_select %>%
  mutate(taxonID = factor(taxonID),
         siteID = factor(siteID),
         month = month(passStartTime),
         year = year(passStartTime),
         siteID = factor(siteID),
         season = factor(ifelse(month %in% c(3,4,5), "spring",
                         ifelse(month %in% c(6,7,8), "summer",
                                ifelse(month %in% c(9,10,11), "fall", "winter"))))) %>%
  group_by(siteID, season, year, month) %>%
  summarize(unique_taxa = n_distinct(taxonID),
            total_individuals = n())

print(fish_by_season)

 
```
## Use an ANOVA test to find correlation between unique species and season for each site

```{r chunk 5}

# MACRO ANOVA

unique_taxa_aov_macro <- aov(unique_taxa ~ season * siteID, data = macro_by_season)

summary(unique_taxa_aov_macro)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov_macro, which = 1:3)

# Additive Model
unique_taxa_aov2_macro <- aov(unique_taxa ~ season + siteID, data = macro_by_season)

summary(unique_taxa_aov2_macro)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov2_macro, which = 1:3)

```
The data above from the ANOVA test and Additive models show that the siteID's have a significant correlation among them, while season and season:siteID do not have significant correlation. Essentially, the trend we are seeing with seasons and the fluxuations of species diversity are consistant between sites. The p value for siteID was 7.39x10^-7, and the F value was 71.097.Relationship is non linear as displayed by the residuals vs fitted plot, Residuals are approximately normally distributed as seen in the q-q residuals plot, and the there is not a constant variation of residuals as displayed in the scale-location plot.
```{r chunk 5}
# FISH ANOVA

unique_taxa_aov_fish <- aov(unique_taxa ~ season * siteID, data = fish_by_season)

summary(unique_taxa_aov_fish)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov_fish, which = 1:3)

# Additive Model
unique_taxa_aov2_fish <- aov(unique_taxa ~ season + siteID, data = fish_by_season)

summary(unique_taxa_aov2_fish)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov2_fish, which = 1:3)
```
The ANOVA test and Additive model reflect the same results as the macroinvertebrate data, with siteID proving significant correlation within them. The p value is 4.37x10^-5 and the F value is 63.984. This data informs us that the fluxuations of species diversity are not only consistant between sites, but also across fish species and macroinvertebrate species, regardless of the site location and geography.Relationship is non linear as displayed by the residuals vs fitted plot, Residuals are not approximately normally distributed as seen in the q-q residuals plot, and the there is not a constant variation of residuals as displayed in the scale-location plot.


```{r chunk 6}
# MACRO SITE GRAPH

ggplot(macro_by_season,
       aes(x = season,
           y = unique_taxa,
           fill = siteID)) +
  geom_boxplot() +
  theme_bw()

```
The box plot above shows the data for the unique macroinvertebrate species collected between both sites MAYF and BIGC. The y axis shows the number of unique taxa collected while the x axis shows the season. The blue bars show MAYF data while the orange/red bars show data for BIGC. The overall trend for both sites looks relatively similar, however the MAYF site does show a considerable less amount of unique macroinvertebrates collected.
```{r chunk 6}
# FISH SITE GRAPH

ggplot(fish_by_season,
       aes(x = season,
           y = unique_taxa,
           fill = siteID)) +
  geom_boxplot() +
  facet_wrap(. ~ siteID, 
             scales = "free_y") +
  theme_bw()
```

The box plot above shows the data for the unique fish species collected between both sites MAYF and BIGC. The y axis shows the number of unique taxa collected while the x axis shows the season. The blue bars show MAYF data while the orange/red bars show data for BIGC. The graphs havee been split to show the very low amount of BIGC fish collected when compared to MAYF. The BIGC fish species start low in the fall and spike in the spring, with no data to show for winter. The MAYF fish species show an opposite trend, with unique taxa collected being high in the fall and decrease in the spring and are lowest in the winter.
```{r chunk 7}
#Second graph with additional context
ggplot() +
  geom_point(data = fish_by_month, aes(x=month, y=unique_taxa, colour = "Fish"))+
  geom_point(data = macro_by_month, aes(x=month, y=unique_taxa, colour = "Macroinvertebrates"))+
  theme_bw()+
  labs(x = "Month",
       y = "Number of different species")+
  scale_colour_manual(values = c("red","blue"))+
  ggtitle("Plot of diversity per month")

```

In the graph above, we used a scatterplot with the y axis representing the number of different unique species, and the x axis showing months. This graph shows the species counts of fish (represented by red dots) and species count of macroinvertebrates (represented by blue dots). The above trend is a bit murky to interpret, but for macroinvertebrate data, there are peaks at the beginning and end of the year, while the fish species count stays relatively consistant.

