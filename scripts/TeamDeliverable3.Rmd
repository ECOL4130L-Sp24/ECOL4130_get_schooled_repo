---
title: "Consolidated data wrangling & analysis"
author: "Carmel, Mathews, Andrea, Nicole"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

# Fish Diversity Correlation to Macroinvertebrate Diversity Over Time

Authors: Andrea Mascioli, Carmel Serban, Nicole Landry, Matthews Do Carmo Nascimiento

## Load necessary packages

```{r chunk 1, message = FALSE}
library(tidyverse)
library(here)
library(broom)
```

## Load raw datasets

```{r chunk 2}
# Fish sampled
fish_raw <- read_csv(here("data", "raw", "fsh_perFish.csv"))

# Macroinvertebrates
macro_raw <- read_csv(here("data", "raw", "inv_taxonomyProcessed.csv")) 

# Stream temperature
#temp_raw <- read_csv(here("data", "raw", "TSW_30min.csv"))

```

# Data wrangling (Selecting fish diversity and macroinvertebrate data)

Define NEON site types 
```{r}
stream_sites <- c("ARIK", "BIGC", "BLDE", "BLUE", "CARI", "CUPE", "GUIL", "HOPB", "KING", "LECO", "LEWI", "MART", "MAYF", "MCDI", "MCRA", "POSE", "PRIN", "REDB", "SYCA", "TECR",  "WALK", "WLOU")

lake_sites <- c("CRAM", "TOOK", "PRLA", "LIRO", "PRPO")

```

## Fish diversity
```{r chunk 3}

## Select focal variables for fish
fish_select <- fish_raw %>% 
  filter(siteID %in% c(stream_sites)) %>% 
  mutate(taxonID = factor(taxonID),
         siteID = factor(siteID),
         sample_month = as_date(floor_date(passStartTime, "month")),
         month = month(sample_month),
         year = year(sample_month),
         season = factor(ifelse(month %in% c(3,4,5), "spring",
                         ifelse(month %in% c(6,7,8), "summer",
                                ifelse(month %in% c(9,10,11), "fall", "winter"))))) %>% 
  dplyr::select(siteID, sample_month, month, year, season, taxonID, scientificName, fishWeight)

```

Summarize fish diversity by month/year and season
```{r}
fish_by_month <- fish_select %>% 
  group_by(siteID, sample_month) %>% 
  summarize(fish_unique_taxa = n_distinct(taxonID),
            total_individuals = n(),
            total_biomass = sum(fishWeight, na.rm = TRUE)) %>% 
  write_csv(., here("data", "processed", "fish_by_month.csv"))

print(fish_by_month) 

## Summarize fish diversity by season 
fish_by_season <- fish_select %>%
  group_by(siteID, season, year) %>%
  summarize(fish_unique_taxa = n_distinct(taxonID),
            total_individuals = n(),
            total_biomass = sum(fishWeight, na.rm = TRUE)) %>% 
  write_csv(., here("data", "processed", "fish_by_season.csv"))

print(fish_by_season)

```

## Macroinvertebrates
```{r}

## Select focal variables
macro_select <- macro_raw %>% 
  filter(siteID %in% c(stream_sites)) %>% 
  mutate(taxonID = factor(acceptedTaxonID),
         siteID = factor(siteID),
         sample_month = as_date(floor_date(collectDate, "month")),
        month = month(sample_month),
         year = year(sample_month),
         season = factor(ifelse(month %in% c(3,4,5), "spring",
                         ifelse(month %in% c(6,7,8), "summer",
                                ifelse(month %in% c(9,10,11), "fall", "winter"))))) %>% 
  filter(season %in% c("spring", "fall")) %>% 
  dplyr::select(siteID, sample_month, month, year, season, genus, taxonID, scientificName, sizeClass, sizeCategory, individualCount, estimatedTotalCount)

## Separate data to get macroinvertebrate data by month.
macro_by_month <- macro_select %>% 
  group_by(siteID, sample_month) %>% 
  summarize(macro_unique_taxa = n_distinct(taxonID),
            total_individuals = sum(estimatedTotalCount)) %>% 
  write_csv(., here("data", "processed", "macro_by_month.csv"))

print(macro_by_month)

macro_by_season <- macro_select %>%
  group_by(siteID, season, year) %>%
  summarize(macro_unique_taxa = n_distinct(taxonID),
            total_individuals = sum(estimatedTotalCount)) %>% 
  write_csv(., here("data", "processed", "macro_by_season.csv"))

print(macro_by_season)

```

## Join fish and macro 
Join by siteID, season, and year to retain unique taxa for fish and macroinverts

```{r}
joined_data <- full_join((fish_by_season %>% 
                            dplyr::select(siteID:fish_unique_taxa)),
                          (macro_by_season %>% 
                            dplyr::select(siteID:macro_unique_taxa))) %>% 
  drop_na()

head(joined_data)
```

How many complete observations per site were there?
Which site/season combinations had multiple observations (e.g., across years)
```{r sites_to_keep}
site_season_summary <- joined_data %>% 
  group_by(siteID, season) %>% 
  summarize(obs = n())

site_season_summary

keep <- c("ARIK", "BIGC", "HOPB", "KING", "LECO", "LEWI", "MAYF", "MCDI", "POSE", "REDB", "WALK", "WLOU")

site_colors <- c("#F8766D", "#DE8C00", "#B79F00", "#7cae00", "#00BA38", "#00c08b",
                 "#00bfc4", "#00b4f0", "#619cff", "#c77cff", "#f564e3", "#ff64b0")
```

Retain only stream sites that had multiple observations per season across years; multiple seasons
```{r filter_joined_data}
streams_to_test <- joined_data %>% 
  filter(siteID %in% keep)
```

Potential way to phrase site selection in your methods: 

"We selected NEON sites to maximize the range of sites examined while ensuring sufficient replication for statistical analysis. We retained sites that had at least two sampling instances for fish and macroinvertebrates in both Fall and Spring seasons. This resulted in 12 total sites ranging from Alaksa (ARIK) to Alabama (MAYF) and California (BIGC) to Massachusetts (HOPB)."

Sites selected: 
"ARIK", "BIGC", "HOPB", "KING", "LECO", "LEWI", "MAYF", "MCDI", "POSE", "REDB", "WALK", "WLOU"

## Inverts as a function of fish
Use Poisson regression model since data are counts (positive integer values only)
```{r}

mod1 <- glm(fish_unique_taxa ~ macro_unique_taxa * siteID * season, 
            data = streams_to_test,
            family = poisson)

# Test for overdispersion
mod1$deviance / mod1$df.residual

# No overdispersion issue; interpret output
summary(mod1)

```
Interpretation: No sig. interactions between site, season, invert diversity; simplify to run as additive model

Additive model including macroinvert richness, siteID, season
```{r}

mod2 <- glm(fish_unique_taxa ~ macro_unique_taxa + siteID + season, 
            data = streams_to_test,
            family = poisson)

mod2$deviance / mod2$df.residual

summary(mod2)

anova(mod2, test = "Chisq")

```
Interpretation: We see site-specific differences in unique fish taxa, but macroinvert. taxon richness is not a significant predictor.
We did not see significant differences in fish taxon richness between fall and spring seasons. Note that all site significances are indicated as whether they are sig. different from ARIK (alphabetically first)


Make a graph of fish as a function of inverts across selected stream sites
```{r}
ggplot(streams_to_test,
       aes(x = macro_unique_taxa,
           y = fish_unique_taxa,
           fill = siteID)) +
  geom_point(cex = 4, pch = 21) +
  scale_x_continuous(limits = c(0, 150)) +
  scale_y_continuous(limits = c(0, 35),
                     breaks = seq(0, 35, 5)) +
  theme_bw()

```
# Data analysis

## Macroinvertebrate ANOVA

**KF note: Here and for fish below, remember that ANOVA is testing for differences in mean values across groups, not correlation among variables!**

Use an ANOVA test to determine whether mean macro. taxon richness differed by season and/or site
```{r chunk 5}

# Set up model
unique_taxa_aov_macro <- aov(macro_unique_taxa ~ season * siteID, data = streams_to_test)

summary(unique_taxa_aov_macro)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov_macro, which = 1:3)

# Additive Model
unique_taxa_aov2_macro <- aov(macro_unique_taxa ~ season + siteID, data = streams_to_test)

summary(unique_taxa_aov2_macro)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov2_macro, which = 1:3)

# Tukey test
sig_outcomes <- as_tibble(tidy(TukeyHSD(unique_taxa_aov2_macro))) %>% 
  filter(adj.p.value < .05)

sig_outcomes


```
Interpretation: There were significant differences in mean macroinvertebrate taxon richness between stream sites. There were not significant differences between fall and spring samplings. 

## Fish ANOVA

Use an ANOVA test to determine whether mean fish richness differed by season and/or site
```{r chunk 5}

unique_taxa_aov_fish <- aov(fish_unique_taxa ~ season * siteID, data = streams_to_test)

summary(unique_taxa_aov_fish)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov_fish, which = 1:3)

# Additive Model
unique_taxa_aov2_fish <- aov(fish_unique_taxa ~ season + siteID, data = streams_to_test)

summary(unique_taxa_aov2_fish)

#Diagnostic Plots
par(mfrow = c(1, 3))
plot(unique_taxa_aov2_fish, which = 1:3)
```
As with macroinvertebrates, there were site-specific differences in fish diversity, but diversity did not differ between fall and spring samplings.


Boxplot of macroinvertebrate richness across sites
Season not included in plots because it was not significant in models
```{r chunk 6}

ggplot(streams_to_test,
       aes(x = (fct_reorder(siteID, macro_unique_taxa, .fun = median)),
           y = macro_unique_taxa,
           fill = siteID)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 150)) +
  labs(x = "NEON site ID") +
  guides(fill = "none") +
  theme_bw()

```

Boxplot of fish richness across sites
Season not included in plots because it was not significant in models
```{r chunk 6}
ggplot(streams_to_test,
       aes(x = (fct_reorder(siteID, fish_unique_taxa, .fun = median)),
           y = fish_unique_taxa,
           fill = siteID)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 35),
                     breaks = seq(0, 35,5)) +
  labs(x = "NEON site ID") +
  guides(fill = "none") +
  theme_bw()

# Cross-site patterns in fish taxon richness between fall/spring
ggplot(data = streams_to_test, 
       aes(x = season, 
           y = fish_unique_taxa,
           fill = season)) +
  geom_boxplot() +
  theme_bw()
```

```{r chunk 7}
#Second graph with additional context
ggplot() +
  geom_point(data = fish_by_month, aes(x=sample_month, y=fish_unique_taxa, colour = "Fish"))+
  geom_point(data = macro_by_month, aes(x=sample_month, y=macro_unique_taxa, colour = "Macroinvertebrates"))+
  theme_bw()+
  labs(x = "Month",
       y = "Number of different species")+
  scale_colour_manual(values = c("red","blue"))+
  ggtitle("Plot of diversity per month")

```

In the graph above, we used a scatterplot with the y axis representing the number of different unique species, and the x axis showing months. This graph shows the species counts of fish (represented by red dots) and species count of macroinvertebrates (represented by blue dots). The above trend is a bit murky to interpret, but for macroinvertebrate data, there are peaks at the beginning and end of the year, while the fish species count stays relatively consistant.

